package com.magic.mywebsocket;

import android.os.Bundle;
import android.util.Log;
import android.view.View;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;

import com.magic.magicwebsocket.client.BBIpcRequest;
import com.magic.magicwebsocket.client.base.Callback;
import com.magic.magicwebsocket.client.base.TargetCallback;
import com.magic.magicwebsocket.server.MWebSocketServer;
import com.magic.magicwebsocket.temp.MyClient;



import java.io.IOException;


public class MainActivity extends AppCompatActivity {

    private static final String TAG = "Magic-MainActivity";
    public static MWebSocketServer webSocketServer =null;
    public static BBIpcRequest bbIpcRequest=null;
    public static Thread thread = null;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -> {
            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            return insets;
        });
    }
    BBIpcRequest m_bbIpcRequest1 =null;
    public void kehuduan_1(View view) {
        new Thread(new Runnable() {
            @Override
            public void run() {
                if(m_bbIpcRequest1==null){
                    m_bbIpcRequest1 =new BBIpcRequest("客户端1","123",9999);
                    m_bbIpcRequest1.register("客户端1");
                }
                try {
//                    String execute = m_bbIpcRequest1.execute("客户端2","客户端2-you-pkg", "123123", 30);
//                    Log.d(TAG, "客户端1 收到的数据: "+execute);

                    m_bbIpcRequest1.enqueue(
                            "客户端2",
                            "客户端2-you-pkg",
                            "123123",
                            3, new Callback() {
                        @Override
                        public void onFailure(IOException ioException) {
                            super.onFailure(ioException);
                            Log.d(TAG, "客户端1 异常: "+ioException.toString());
                        }

                        @Override
                        public void onResponse(String Body) {
                            super.onResponse(Body);
                            Log.d(TAG, "客户端1 收到的数据: "+Body);
                        }
                    });

                } catch (IOException e) {
                    Log.d(TAG, "run: "+e.toString());
//                    throw new RuntimeException(e);
                }
            }
        }).start();


    }

    public void kehuduan_2(View view) {
        BBIpcRequest bbIpcRequest1 =new BBIpcRequest("客户端2","123",9999,1);
        String execute = null;
        try {
            boolean is_register = bbIpcRequest1.register("客户端2");

            bbIpcRequest1.addHandlerForTarget("客户端2-you-pkg", new TargetCallback() {
                @Override
                public String onRequest(String target, String fromPkg, String fromProcessName, String data) {
                    if (target.equals("客户端2-you-pkg")){
                        String result = "hello";
                        Log.d(TAG, "客户端2 onRequest: 接受数据 = "+data+" 返回的内容 = "+result);
                        return result;
                    }
                    return super.onRequest(target, fromPkg, fromProcessName, data);
                }
            });


//            execute = bbIpcRequest1.execute("123", "123123", 30);
//            Log.d(TAG, "run: "+execute);
//            bbIpcRequest1.enqueue("客户端1", "123123", 30, new Callback() {
//                @Override
//                public void onFailure(IOException ioException) {
//                    super.onFailure(ioException);
//                    Log.d(TAG, "onFailure: "+ioException);
//                }
//
//                @Override
//                public void onResponse(String Body) {
//                    super.onResponse(Body);
//                    Log.d(TAG, "onResponse: "+Body);
//                }
//            });
        } catch (Exception e) {
            Log.d(TAG, "onClick: "+e.toString());
//            throw new RuntimeException(e);
        }
    }

//    public MyInjectedWSServer m_myInjectedWSServer = null;
    public void onClick1(View view) {

//        //开启服务端
//       new Thread(new Runnable() {
//           @Override
//           public void run() {
//               boolean b = webSocketServer.startServer();
//               if (b){
//                   Log.d("Magic-主线程", "onClick1: 启动成功");
//               }
//           }
//       }).start();

        if(webSocketServer==null){
            webSocketServer=new MWebSocketServer(9999);
        }
        boolean flag = webSocketServer.startServer();
        if(!flag){
            Log.d(TAG, "onClick1: 服务器初始化失败");
        }else{
            Log.d(TAG, "onClick1: 服务器初始化成功");
        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

//        if(m_myInjectedWSServer==null){
//            m_myInjectedWSServer = new MyInjectedWSServer(9999);
//        }
//        m_myInjectedWSServer.mystart();
    }

    public void onClick2(View view) {
//        webSocketServer.stopServer();
    }


}